<!DOCTYPE html>

<html lang="es">

<head>

  <meta charset="UTF-8">

  <title>Autopartes El R√°pido - Pedidos</title>

  <style>

    /* Auto theme using system setting */
    :root {

      color-scheme: light dark;

      /* LIGHT MODE (default) */
      --bg-body: #f4f4f4;
      --text-color: #111111;
      --container-bg: #ffffff;
      --section-bg: #f4f4f6;
      --border-color: #dddddd;
      --input-bg: #ffffff;
      --table-even: #f9f9f9;
      --table-odd: #ffffff;
      --muted-color: #555555;
      --button-bg: #007bff;
      --button-bg-hover: #0056b3;
      --button-secondary: #cccccc;
      --button-secondary-hover: #bbbbbb;
      --button-danger: #d9534f;
      --button-danger-hover: #c9302c;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-body: #17181c;
        --text-color: #f5f5f5;
        --container-bg: #22232a;
        --section-bg: #2a2b33;
        --border-color: #444444;
        --input-bg: #17181c;
        --table-even: #272831;
        --table-odd: #20212a;
        --muted-color: #aaaaaa;
        --button-bg: #007bff;
        --button-bg-hover: #0056b3;
        --button-secondary: #444b;
        --button-secondary-hover: #555b;
        --button-danger: #c82333;
        --button-danger-hover: #a71d2a;
      }
    }

    /* Force manual theme (overrides automatic) */
    :root[data-theme="light"] {
      --bg-body: #f4f4f4;
      --text-color: #111111;
      --container-bg: #ffffff;
      --section-bg: #f4f4f6;
      --border-color: #dddddd;
      --input-bg: #ffffff;
      --table-even: #f9f9f9;
      --table-odd: #ffffff;
      --muted-color: #555555;
      --button-bg: #007bff;
      --button-bg-hover: #0056b3;
      --button-secondary: #cccccc;
      --button-secondary-hover: #bbbbbb;
      --button-danger: #d9534f;
      --button-danger-hover: #c9302c;
    }

    :root[data-theme="dark"] {
      --bg-body: #17181c;
      --text-color: #f5f5f5;
      --container-bg: #22232a;
      --section-bg: #2a2b33;
      --border-color: #444444;
      --input-bg: #17181c;
      --table-even: #272831;
      --table-odd: #20212a;
      --muted-color: #aaaaaa;
      --button-bg: #007bff;
      --button-bg-hover: #0056b3;
      --button-secondary: #444b;
      --button-secondary-hover: #555b;
      --button-danger: #c82333;
      --button-danger-hover: #a71d2a;
    }
    body {

      font-family: Arial, sans-serif;

      background: var(--bg-body);

      color: var(--text-color);

      margin: 0;

      padding: 20px;

    }

    h1, h2, h3 {

      margin: 0 0 10px;

    }

    a {

      color: #4da3ff;

    }

    .container {

      max-width: 1200px;

      margin: 0 auto;

      background: var(--container-bg);

      padding: 20px;

      border-radius: 10px;

      box-shadow: 0 0 10px rgba(0,0,0,0.6);

    }

    .section {

      margin-bottom: 20px;

      padding: 15px;

      border-radius: 8px;

      background: var(--section-bg);

    }

    label {

      font-weight: bold;

      display: block;

      margin-bottom: 4px;

      font-size: 13px;

    }

    input[type="text"],

    input[type="number"],

    select {

      width: 100%;

      padding: 6px 8px;

      border-radius: 5px;

      border: 1px solid var(--border-color);

      box-sizing: border-box;

      background: var(--input-bg);

      color: var(--text-color);

      font-size: 13px;

    }

    input[type="number"] {

      text-align: right;

    }

    .grid {

      display: grid;

      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));

      gap: 12px;

    }

    button {

      padding: 8px 14px;

      border: none;

      border-radius: 6px;

      background: var(--button-bg);

      color: #fff;

      font-size: 13px;

      cursor: pointer;

      margin-right: 6px;

      margin-top: 6px;

    }

    button.secondary {

      background: var(--button-secondary);

    }

    button.danger {

      background: var(--button-danger);

    }

    button:hover {

      background: var(--button-bg-hover);

    }

    button.secondary:hover {

      background: var(--button-secondary-hover);

    }

    button.danger:hover {

      background: var(--button-danger-hover);

    }

    .badge {

      display: inline-block;

      padding: 3px 8px;

      border-radius: 999px;

      font-size: 11px;

      margin-left: 5px;

    }

    .badge-open {

      background: #155724;

      color: #d4edda;

    }

    .badge-closed {

      background: #856404;

      color: #fff3cd;

    }

    table {

      width: 100%;

      border-collapse: collapse;

      margin-top: 10px;

      font-size: 12px;

    }

    th, td {

      border: 1px solid var(--border-color);

      padding: 5px;

      text-align: center;

    }

    th {

      background: #007bff;

      color: #fff;

      position: sticky;

      top: 0;

      z-index: 1;

    }

    tbody tr:nth-child(even) {

      background: var(--table-even);

    }

    tbody tr:nth-child(odd) {

      background: var(--table-odd);

    }

    td input[type="number"],

    td input[type="text"] {

      width: 100%;

      font-size: 11px;

      padding: 3px 4px;

    }

    .resumen ul {

      list-style: none;

      padding-left: 0;

      margin: 0;

      font-size: 13px;

    }

    .resumen li {

      margin-bottom: 4px;

    }

    .small-note {

      font-size: 11px;

      opacity: 0.8;

      color: var(--muted-color);

    }


    /* ============================
       RESPONSIVE DESIGN
       ============================ */

    /* More compact container on small screens */
    @media (max-width: 900px) {

      .container {

        padding: 15px;

      }

      h1, h2 {

        font-size: 20px;

      }

    }

    /* Stack grids vertically */
    @media (max-width: 700px) {

      .grid {

        grid-template-columns: 1fr;

      }

    }

    /* Scrollable table on mobile */
    @media (max-width: 750px) {

      table {

        display: block;

        overflow-x: auto;

        white-space: nowrap;

        border-radius: 8px;

      }

      th, td {

        min-width: 120px;

        font-size: 12px;

        padding: 6px 8px;

      }

    }

    /* Larger touch targets on mobile */
    @media (max-width: 600px) {

      input, select, button {

        font-size: 14px;

        padding: 10px;

      }

      button {

        width: 100%;

        margin-bottom: 6px;

      }

    }

    /* Better spacing on very small screens */
    @media (max-width: 430px) {

      h1 {

        font-size: 18px;

      }

      .section {

        padding: 12px;

      }

    }

    /* ============================
       TOASTS / NOTIFICACIONES
       ============================ */
    #toastContainer {
      position: fixed;
      right: 15px;
      bottom: 15px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast {
      min-width: 220px;
      max-width: 320px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      opacity: 0;
      transform: translateY(10px);
      animation: toast-in 0.2s forwards;
    }
    .toast button {
      background: transparent;
      border: none;
      color: inherit;
      font-size: 14px;
      cursor: pointer;
      margin-left: 8px;
      padding: 0;
    }
    .toast-success { background: #28a745; }
    .toast-info    { background: #17a2b8; }
    .toast-warn    { background: #ffc107; color: #222; }
    .toast-error   { background: #dc3545; }
    @keyframes toast-in {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes toast-out {
      from { opacity: 1; transform: translateY(0); }
      to   { opacity: 0; transform: translateY(10px); }
    }
    @media (max-width: 600px) {
      #toastContainer {
        left: 50%;
        transform: translateX(-50%);
        right: auto;
      }
    }
  </style>

</head>

<body>

  <div class="container">

    <h1>Autopartes El R√°pido - Control por pedidos</h1>
    <button id="toggleThemeBtn" class="secondary" style="float:right; margin-top:-35px;">
      Tema: autom√°tico
    </button>
    <div style="clear:both;"></div>



    <!-- SECTION: ORDERS -->

    <div class="section">

      <h2>Pedidos de eBay</h2>

      <div class="grid">

        <div>

          <label for="pedidoNombre">Nombre del pedido</label>

          <input id="pedidoNombre" type="text" placeholder="Ej. Pedido filtros Noviembre">

        </div>

        <div>

          <label for="pedidoTipoCambio">Tipo de cambio (MXN por 1 USD)</label>

          <input id="pedidoTipoCambio" type="number" step="0.01" min="0" value="19.50">

          <div class="small-note">Se usa para convertir los art√≠culos que vengan en d√≥lares.</div>

        </div>

        <div>

          <label for="pedidoSelect">Seleccionar pedido</label>

          <select id="pedidoSelect"></select>

          <div class="small-note">Elige un pedido existente para ver/editar sus piezas.</div>

        </div>

      </div>

      <div style="margin-top:10px;">

        <button id="crearPedidoBtn">Crear nuevo pedido</button>

        <button id="marcarFinalizadoBtn" class="secondary">Marcar pedido como ‚Äúfinalizado‚Äù</button>

        <button id="borrarPedidoBtn" class="danger">Borrar pedido actual</button>

      </div>

      <div style="margin-top:8px;">

        <span id="infoPedidoActual" class="small-note"></span>

      </div>

    </div>



    <!-- SECTION: ADD ITEM -->

    <div class="section">

      <h2>Agregar pieza al pedido actual</h2>

      <div class="grid">

        <div>

          <label for="piezaNombre">Nombre de la pieza</label>

          <input id="piezaNombre" type="text" placeholder="Ej. Espaciadores Charger 1-1/2">

        </div>

        <div>

          <label for="piezaMoneda">Moneda del precio de compra</label>

          <select id="piezaMoneda">

            <option value="USD">D√≥lares (USD)</option>

            <option value="MXN">Pesos (MXN)</option>

          </select>

        </div>

        <div>

          <label for="piezaPrecioCompra">Precio total pagado</label>

          <input id="piezaPrecioCompra" type="number" step="0.01" min="0" placeholder="Ej. 180">

          <div class="small-note">Si est√° en USD se convierte con el tipo de cambio del pedido.</div>

        </div>

        <div>

          <label for="piezaCantidad">Cantidad de piezas</label>

          <input id="piezaCantidad" type="number" step="1" min="1" value="1">

        </div>

        <div>

          <label for="piezaPvSugerido">Precio de venta sugerido (MXN)</label>

          <input id="piezaPvSugerido" type="number" step="0.01" min="0" placeholder="Solo informativo">

        </div>

      </div>

      <div style="margin-top:10px;">

        <button id="agregarPiezaBtn">Agregar pieza al pedido</button>

      </div>

    </div>



    <!-- SECTION: ITEMS TABLE -->

    <div class="section">

      <h2>Piezas del pedido</h2>

      <div class="small-note">

        Puedes editar directamente los campos de venta, importaci√≥n y gastos en la tabla.  

        La ganancia se recalcula sola y todo se guarda en el navegador (localStorage).

      </div>

      <table>

        <thead>
          <tr>
            <th>#</th>
            <th>Nombre</th>
            <th>Moneda</th>
            <th>Precio unitario</th>
            <th>Cant.</th>
            <th>Costo MXN</th>
            <th>PV sugerido</th>
          </tr>
        </thead>

        <tbody id="tablaPiezasBody">

          <!-- rows -->

        </tbody>

      </table>

    </div>



    <!-- SECTION: ORDER SUMMARY -->



  </div>

  <div class="section">

    <h2>Gastos del pedido</h2>

    <h3 style="margin-top:5px;">Importaci√≥n</h3>
    <div class="grid">
      <div>
        <label for="impMonto">Monto importaci√≥n (MXN)</label>
        <input id="impMonto" type="number" step="0.01" min="0" placeholder="Ej. 350">
      </div>
      <div>
        <label for="impNota">Comentario (opcional)</label>
        <input id="impNota" type="text" placeholder="Ej. Aduana, FedEx, etc.">
      </div>
      <div style="align-self:end;">
        <button id="agregarImportacionBtn">Agregar importaci√≥n (individual)</button>
      </div>
    </div>

    <h3 style="margin-top:15px;">Gastos personales / del local</h3>
    <div class="grid">
      <div>
        <label for="gpMonto">Monto gasto personal (MXN)</label>
        <input id="gpMonto" type="number" step="0.01" min="0" placeholder="Ej. 200">
      </div>
      <div>
        <label for="gpMotivo">Motivo / raz√≥n (obligatorio)</label>
        <input id="gpMotivo" type="text" placeholder="Ej. comida, pintura del local, etc.">
      </div>
      <div style="align-self:end;">
        <button id="agregarGastoPersonalBtn">Agregar gasto personal</button>
      </div>
    </div>

    <h3 style="margin-top:15px;">Listado de gastos</h3>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Tipo</th>
          <th>Monto</th>
          <th>Motivo / Nota</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody id="tablaGastosBody">
        <!-- filas -->
      </tbody>
    </table>
  </div>

  <div class="section">

    <h2>Ventas</h2>

    <div class="grid">
      <div>
        <label for="ventaNombre">Nombre de la pieza</label>
        <input id="ventaNombre" type="text" placeholder="Debe coincidir con una pieza del pedido">
      </div>

      <div>
        <label for="ventaCantidad">Cantidad vendida</label>
        <input id="ventaCantidad" type="number" min="1" step="1" placeholder="Ej. 1">
      </div>

      <div>
        <label for="ventaPrecio">Precio total vendido (MXN)</label>
        <input id="ventaPrecio" type="number" step="0.01" min="0" placeholder="Ej. 2500">
      </div>

      <div style="align-self:end;">
        <button id="agregarVentaBtn">Registrar venta</button>
      </div>
    </div>

    <h3 style="margin-top:15px;">Historial de ventas</h3>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Pieza</th>
          <th>Cant.</th>
          <th>Precio total</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody id="tablaVentasBody">
        <!-- filas -->
      </tbody>
    </table>
  </div>

  <!-- AHORA PEGA AQU√ç EL RESUMEN -->
  <div class="section resumen">

    <h2>Resumen del pedido</h2>

    <ul>

      <li><strong>Total inversi√≥n (costo MXN):</strong> <span id="resTotalInversion">0.00</span></li>

      <li><strong>Total ventas (PV final):</strong> <span id="resTotalVentas">0.00</span></li>

      <li><strong>Total importaci√≥n:</strong> <span id="resTotalImportacion">0.00</span></li>

      <li><strong>Total gastos:</strong> <span id="resTotalGastos">0.00</span></li>

      <li><strong>Ganancia neta:</strong> <span id="resGananciaNeta">0.00</span></li>

      <li><strong>Ganancia de hoy:</strong> <span id="resGananciaHoy">0.00</span></li>
      <li><strong>Ganancia de ayer:</strong> <span id="resGananciaAyer">0.00</span></li>

    </ul>

  </div>

  <!-- TOASTS -->
  <div id="toastContainer"></div>

  <script>

    // === THEME LIGHT/DARK ===
    const THEME_STORAGE_KEY = "apr_tema_pref"; // "auto" | "light" | "dark"

    function updateThemeButtonLabel(theme) {
      const btn = document.getElementById("toggleThemeBtn");
      if (!btn) return;
      if (theme === "light") btn.textContent = "Tema: claro";
      else if (theme === "dark") btn.textContent = "Tema: oscuro";
      else btn.textContent = "Tema: autom√°tico";
    }

    function applyTheme(theme) {
      const root = document.documentElement;
      if (theme === "light") {
        root.setAttribute("data-theme", "light");
      } else if (theme === "dark") {
        root.setAttribute("data-theme", "dark");
      } else {
        // automatic: use system preference
        root.removeAttribute("data-theme");
        theme = "auto";
      }
      localStorage.setItem(THEME_STORAGE_KEY, theme);
      updateThemeButtonLabel(theme);
    }

    // === TOASTS & BEEP ===
    function playBeep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.value = 880;
        osc.connect(gain);
        gain.connect(ctx.destination);
        gain.gain.setValueAtTime(0.15, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.18);
        osc.start();
        osc.stop(ctx.currentTime + 0.2);
      } catch (e) {}
    }
    function showToast(type, message, withSound = false) {
      const container = document.getElementById("toastContainer");
      if (!container) return;
      const div = document.createElement("div");
      div.classList.add("toast");
      if (type === "success") div.classList.add("toast-success");
      else if (type === "info") div.classList.add("toast-info");
      else if (type === "warn") div.classList.add("toast-warn");
      else if (type === "error") div.classList.add("toast-error");
      else div.classList.add("toast-info");
      div.innerHTML = `
        <span>${message}</span>
        <button aria-label="Cerrar">&times;</button>
      `;
      const closeBtn = div.querySelector("button");
      closeBtn.addEventListener("click", () => closeToast(div));
      container.appendChild(div);
      if (withSound) playBeep();
      setTimeout(() => closeToast(div), 3500);
    }
    function closeToast(el) {
      el.style.animation = "toast-out 0.2s forwards";
      setTimeout(() => {
        if (el.parentNode) el.parentNode.removeChild(el);
      }, 220);
    }

    // === DATA & LOCALSTORAGE ===

    const STORAGE_KEY_PEDIDOS = "apr_pedidos_v1";



    /**

     * Structure:

     * pedidos = [

     *   {

     *     id, nombre, tipoCambio, finalizado,

     *     items: [

     *       {

     *         id, nombre, moneda, precioCompra,

     *         costoMx, pvSugerido, pvFinal,

     *         importacion, gastos, ganancia

     *       }

     *     ]

     *   }

     * ]

     */

    let pedidos = [];

    let pedidoActualId = null;



    // === DOM ELEMENTS ===

    const pedidoNombreInput = document.getElementById("pedidoNombre");

    const pedidoTipoCambioInput = document.getElementById("pedidoTipoCambio");

    const pedidoSelect = document.getElementById("pedidoSelect");
    const toggleThemeBtn = document.getElementById("toggleThemeBtn");

    const crearPedidoBtn = document.getElementById("crearPedidoBtn");

    const marcarFinalizadoBtn = document.getElementById("marcarFinalizadoBtn");

    const borrarPedidoBtn = document.getElementById("borrarPedidoBtn");

    const infoPedidoActualSpan = document.getElementById("infoPedidoActual");



    const piezaNombreInput = document.getElementById("piezaNombre");

    const piezaMonedaSelect = document.getElementById("piezaMoneda");

    const piezaPrecioCompraInput = document.getElementById("piezaPrecioCompra");
    const piezaCantidadInput = document.getElementById("piezaCantidad");

    const piezaPvSugeridoInput = document.getElementById("piezaPvSugerido");

    const agregarPiezaBtn = document.getElementById("agregarPiezaBtn");



    const tablaPiezasBody = document.getElementById("tablaPiezasBody");

    // GASTOS
    const impMontoInput = document.getElementById("impMonto");
    const impNotaInput = document.getElementById("impNota");
    const gpMontoInput = document.getElementById("gpMonto");
    const gpMotivoInput = document.getElementById("gpMotivo");
    const agregarImportacionBtn = document.getElementById("agregarImportacionBtn");
    const agregarGastoPersonalBtn = document.getElementById("agregarGastoPersonalBtn");
    const tablaGastosBody = document.getElementById("tablaGastosBody");

    // VENTAS
    const ventaNombreInput = document.getElementById("ventaNombre");
    const ventaCantidadInput = document.getElementById("ventaCantidad");
    const ventaPrecioInput = document.getElementById("ventaPrecio");
    const agregarVentaBtn = document.getElementById("agregarVentaBtn");
    const tablaVentasBody = document.getElementById("tablaVentasBody");



    const resTotalInversionSpan = document.getElementById("resTotalInversion");

    const resTotalVentasSpan = document.getElementById("resTotalVentas");

    const resTotalImportacionSpan = document.getElementById("resTotalImportacion");

    const resTotalGastosSpan = document.getElementById("resTotalGastos");

    const resGananciaNetaSpan = document.getElementById("resGananciaNeta");
    const resGananciaHoySpan = document.getElementById("resGananciaHoy");
    const resGananciaAyerSpan = document.getElementById("resGananciaAyer");



    // === UTILITIES ===

    function uuid() {

      return Date.now().toString(36) + Math.random().toString(36).substring(2, 8);

    }

    function money(n) {

      return (n || 0).toFixed(2);

    }



    function guardarLocal() {

      try {

        localStorage.setItem(STORAGE_KEY_PEDIDOS, JSON.stringify({

          pedidos,

          pedidoActualId

        }));

      } catch (e) {

        console.error("Error guardando en localStorage", e);

      }

    }



    function cargarLocal() {

      try {

        const raw = localStorage.getItem(STORAGE_KEY_PEDIDOS);

        if (!raw) return;

        const data = JSON.parse(raw);

        if (Array.isArray(data.pedidos)) {

          pedidos = data.pedidos.map(p => ({
            ...p,
            gastosImportacion: p.gastosImportacion || [],
            gastosPersonales: p.gastosPersonales || [],
            ventas: p.ventas || []
          }));

        }

        if (data.pedidoActualId) {

          pedidoActualId = data.pedidoActualId;

        }

      } catch (e) {

        console.error("Error cargando localStorage", e);

      }

    }



    function getPedidoActual() {

      return pedidos.find(p => p.id === pedidoActualId) || null;

    }



    // === RENDERING ===

    function renderPedidosSelect() {

      pedidoSelect.innerHTML = "";

      if (pedidos.length === 0) {

        const opt = document.createElement("option");

        opt.value = "";

        opt.textContent = "Sin pedidos";

        pedidoSelect.appendChild(opt);

        infoPedidoActualSpan.textContent = "Crea un nuevo pedido para comenzar.";

        return;

      }



      pedidos.forEach(p => {

        const opt = document.createElement("option");

        opt.value = p.id;

        opt.textContent = p.nombre;

        pedidoSelect.appendChild(opt);

      });



      if (!pedidoActualId || !pedidos.some(p => p.id === pedidoActualId)) {

        pedidoActualId = pedidos[0].id;

      }

      pedidoSelect.value = pedidoActualId;

    }



    function renderResumenPedido(pedido) {

      if (!pedido) {

        resTotalInversionSpan.textContent = "0.00";

        resTotalVentasSpan.textContent = "0.00";

        resTotalImportacionSpan.textContent = "0.00";

        resTotalGastosSpan.textContent = "0.00";

        resGananciaNetaSpan.textContent = "0.00";

        infoPedidoActualSpan.textContent = "Sin pedido seleccionado.";

        return;

      }



      let totalInversion = 0;

      let totalVentas = 0;

      let totalImportacion = 0;

      let totalGastos = 0;

      let gananciaNeta = 0;

      let gananciaHoy = 0;
      let gananciaAyer = 0;

      const hoy = new Date();
      const ayer = new Date();
      ayer.setDate(hoy.getDate() - 1);
      function esMismoDia(d1, d2) {
        return d1.getFullYear() === d2.getFullYear() &&
               d1.getMonth() === d2.getMonth() &&
               d1.getDate() === d2.getDate();
      }


      pedido.items.forEach(item => {

        totalInversion += item.costoMx || 0;

        totalVentas += item.pvFinal || 0;

        totalImportacion += item.importacion || 0;

        totalGastos += item.gastos || 0;

        gananciaNeta += item.ganancia || 0;

        if (item.createdAt) {
          const fecha = new Date(item.createdAt);
          if (esMismoDia(fecha, hoy)) {
            gananciaHoy += item.ganancia || 0;
          } else if (esMismoDia(fecha, ayer)) {
            gananciaAyer += item.ganancia || 0;
          }
        }

      });



      // sumar gastos de la nueva secci√≥n
      if (pedido.gastosImportacion) {
        pedido.gastosImportacion.forEach(g => {
          totalImportacion += g.monto || 0;
        });
      }
      if (pedido.gastosPersonales) {
        pedido.gastosPersonales.forEach(g => {
          totalGastos += g.monto || 0;
        });
      }

      // sumar ventas registradas
      if (pedido.ventas) {
        pedido.ventas.forEach(v => {
          totalVentas += v.precioTotal || 0;
        });
      }

      // calcular ganancia neta sobre totales
      gananciaNeta = totalVentas - totalInversion - totalImportacion - totalGastos;

      resTotalInversionSpan.textContent = money(totalInversion);
      resTotalVentasSpan.textContent = money(totalVentas);
      resTotalImportacionSpan.textContent = money(totalImportacion);
      resTotalGastosSpan.textContent = money(totalGastos);
      resGananciaNetaSpan.textContent = money(gananciaNeta);
      if (resGananciaHoySpan) resGananciaHoySpan.textContent = money(gananciaHoy);
      if (resGananciaAyerSpan) resGananciaAyerSpan.textContent = money(gananciaAyer);



      const status = pedido.finalizado ? "Finalizado" : "Abierto";

      infoPedidoActualSpan.innerHTML =

        `Pedido actual: <strong>${pedido.nombre}</strong> | Tipo de cambio: <strong>${money(pedido.tipoCambio)}</strong> | Estado: ` +

        (pedido.finalizado

          ? `<span class="badge badge-closed">Finalizado</span>`

          : `<span class="badge badge-open">Abierto</span>`);

    }



    function renderTablaPiezas(pedido) {
      tablaPiezasBody.innerHTML = "";
      if (!pedido || !pedido.items.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.textContent = "No hay piezas en este pedido.";
        tr.appendChild(td);
        tablaPiezasBody.appendChild(tr);
        return;
      }

      pedido.items.forEach((item, idx) => {
        const tr = document.createElement("tr");

        function tdText(text) {
          const td = document.createElement("td");
          td.textContent = text;
          return td;
        }

        tr.appendChild(tdText(idx + 1));
        tr.appendChild(tdText(item.nombre || "-"));
        tr.appendChild(tdText(item.moneda || "-"));
        tr.appendChild(tdText(money(item.precioUnitario || 0))); // unitario ya calculado
        tr.appendChild(tdText(item.cantidad || 1));
        tr.appendChild(tdText(money(item.costoMx || 0)));      // total MXN
        tr.appendChild(tdText(item.pvSugerido ? money(item.pvSugerido) : "-"));

        tablaPiezasBody.appendChild(tr);
      });
    }

    function renderGastos(pedido) {
      tablaGastosBody.innerHTML = "";
      if (!pedido) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.textContent = "No hay pedido seleccionado.";
        tr.appendChild(td);
        tablaGastosBody.appendChild(tr);
        return;
      }

      const filas = [];
      if (pedido.gastosImportacion) {
        pedido.gastosImportacion.forEach(g => {
          filas.push({
            tipo: "Importaci√≥n",
            monto: g.monto || 0,
            motivo: g.nota || "",
            fecha: g.fecha || ""
          });
        });
      }
      if (pedido.gastosPersonales) {
        pedido.gastosPersonales.forEach(g => {
          filas.push({
            tipo: "Gasto personal",
            monto: g.monto || 0,
            motivo: g.motivo || "",
            fecha: g.fecha || ""
          });
        });
      }

      if (!filas.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.textContent = "No hay gastos registrados para este pedido.";
        tr.appendChild(td);
        tablaGastosBody.appendChild(tr);
        return;
      }

      filas.forEach((f, idx) => {
        const tr = document.createElement("tr");
        function td(text) {
          const td = document.createElement("td");
          td.textContent = text;
          return td;
        }
        tr.appendChild(td(idx + 1));
        tr.appendChild(td(f.tipo));
        tr.appendChild(td(money(f.monto)));
        tr.appendChild(td(f.motivo || "-"));
        tr.appendChild(td(f.fecha ? new Date(f.fecha).toLocaleDateString() : "-"));
        tablaGastosBody.appendChild(tr);
      });
    }

    function renderVentas(pedido) {
      tablaVentasBody.innerHTML = "";

      if (!pedido || !pedido.ventas || !pedido.ventas.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.textContent = "No hay ventas registradas.";
        tr.appendChild(td);
        tablaVentasBody.appendChild(tr);
        return;
      }

      pedido.ventas.forEach((v, idx) => {
        const tr = document.createElement("tr");
        function td(text) {
          const td = document.createElement("td");
          td.textContent = text;
          return td;
        }
        tr.appendChild(td(idx + 1));
        tr.appendChild(td(v.nombre));
        tr.appendChild(td(v.cantidadVendida));
        tr.appendChild(td(money(v.precioTotal)));
        tr.appendChild(td(new Date(v.fecha).toLocaleDateString()));
        tablaVentasBody.appendChild(tr);
      });
    }


    function renderTodo() {

      renderPedidosSelect();

      const pedido = getPedidoActual();

      renderTablaPiezas(pedido);
      renderGastos(pedido);
      renderVentas(pedido);
      renderResumenPedido(pedido);

      guardarLocal();

    }



    // === PROFIT CALCULATION ===

    function recalcularGanancia(item) {
      // Only compute if pvFinal is provided
      if (item.pvFinal == null) {
        item.ganancia = 0;
        return;
      }
      const pvFinal = item.pvFinal || 0;
      const importacion = item.importacion || 0;
      const gastos = item.gastos || 0;
      const costoMx = item.costoMx || 0;
      item.ganancia = pvFinal - costoMx - importacion - gastos;

    }



    // === EVENTS ===
    if (toggleThemeBtn) {
      toggleThemeBtn.addEventListener("click", () => {
        const current = localStorage.getItem(THEME_STORAGE_KEY) || "auto";
        let next;
        if (current === "auto") next = "dark";
        else if (current === "dark") next = "light";
        else next = "auto";
        applyTheme(next);
      });
    }

    crearPedidoBtn.addEventListener("click", () => {

      const nombre = pedidoNombreInput.value.trim();

      const tc = parseFloat(pedidoTipoCambioInput.value) || 0;



      if (!nombre) {

        showToast("warn", "Ponle un nombre al pedido, apa.");

        return;

      }

      if (!tc) {

        showToast("warn", "Pon un tipo de cambio v√°lido.");

        return;

      }



      const nuevoPedido = {

        id: uuid(),

        nombre,

        tipoCambio: tc,

        finalizado: false,

        items: [],
        gastosImportacion: [],
        gastosPersonales: [],
        ventas: []

      };

      pedidos.push(nuevoPedido);

      pedidoActualId = nuevoPedido.id;

      pedidoNombreInput.value = "";

      renderTodo();
      showToast("success", "Nuevo pedido creado, apa ‚úîÔ∏è", true);

    });



    pedidoSelect.addEventListener("change", () => {

      const id = pedidoSelect.value;

      pedidoActualId = id || null;

      const pedido = getPedidoActual();

      if (pedido) {

        pedidoTipoCambioInput.value = pedido.tipoCambio || 19.5;

      }

      renderTodo();

    });



    marcarFinalizadoBtn.addEventListener("click", () => {

      const pedido = getPedidoActual();

      if (!pedido) {

        showToast("warn", "No hay pedido seleccionado.");

        return;

      }

      pedido.finalizado = !pedido.finalizado;

      renderTodo();
      showToast(
        "info",
        pedido.finalizado
          ? "Pedido marcado como finalizado ‚úÖ"
          : "Pedido reabierto, sigue la talacha üîÑ"
      );

    });



    borrarPedidoBtn.addEventListener("click", () => {

      const pedido = getPedidoActual();

      if (!pedido) {

        showToast("warn", "No hay pedido seleccionado.");

        return;

      }

      const confirmar = confirm(

        `¬øSeguro que quieres borrar el pedido "${pedido.nombre}" con todas sus piezas?`

      );

      if (!confirmar) return;

      pedidos = pedidos.filter(p => p.id !== pedido.id);

      pedidoActualId = pedidos.length ? pedidos[0].id : null;

      renderTodo();
      showToast("error", "Pedido borrado, apa. Ya no hay vuelta atr√°s. üóëÔ∏è");

    });



    agregarPiezaBtn.addEventListener("click", () => {

      const pedido = getPedidoActual();

      if (!pedido) {

        showToast("warn", "Primero crea o selecciona un pedido.");

        return;

      }



      const nombre = piezaNombreInput.value.trim();

      const moneda = piezaMonedaSelect.value;

      // precio total pagado

      const precioTotal = parseFloat(piezaPrecioCompraInput.value) || 0;

      const cantidad = parseFloat(piezaCantidadInput.value) || 1;

      // precio unitario = precioTotal / cantidad

      const precioUnitario = cantidad > 0 ? (precioTotal / cantidad) : 0;

      const pvSugerido = parseFloat(piezaPvSugeridoInput.value) || 0;



      if (!nombre) {

        showToast("warn", "Ponle nombre a la pieza, apa.");

        return;

      }

      if (!precioTotal) {

        showToast("warn", "Precio de compra inv√°lido, ch√©calo bien.");

        return;

      }



      const tipoCambio = pedido.tipoCambio || 0;

      // unit cost in MXN

      let costoUnitMx = precioUnitario;

      if (moneda === "USD") {

        if (!tipoCambio) {

          showToast("error", "El pedido no tiene tipo de cambio v√°lido.");

          return;

        }

        costoUnitMx = precioUnitario * tipoCambio;

      }

      // total line cost

      const costoMx = costoUnitMx * cantidad;



      const nuevaPieza = {

        id: uuid(),

        nombre,

        moneda,

        precioTotal,        // lo que t√∫ pagaste en total

        precioUnitario,     // calculado por el sistema

        cantidad,

        costoMx,            // total en MXN

        pvSugerido: pvSugerido || null,

        ganancia: 0,

        createdAt: new Date().toISOString()

      };



      pedido.items.push(nuevaPieza);



      // clear form

      piezaNombreInput.value = "";

      piezaPrecioCompraInput.value = "";

      piezaCantidadInput.value = "1";

      piezaPvSugeridoInput.value = "";



      renderTodo();

      showToast("success", "Sim√≥n, pieza agregada al pedido. ‚úîÔ∏è", true);

    });
    agregarImportacionBtn.addEventListener("click", () => {
      const pedido = getPedidoActual();
      if (!pedido) {
        showToast("warn", "No hay pedido seleccionado, apa.");
        return;
      }
      const monto = parseFloat(impMontoInput.value) || 0;
      const nota = impNotaInput.value.trim();
      if (!monto) {
        showToast("warn", "Pon un monto v√°lido de importaci√≥n.");
        return;
      }
      pedido.gastosImportacion.push({
        id: uuid(),
        monto,
        nota,
        fecha: new Date().toISOString()
      });
      impMontoInput.value = "";
      impNotaInput.value = "";
      showToast("info", "Gasto de importaci√≥n agregado (individual) ‚úîÔ∏è", true);
      renderTodo();
    });

    agregarGastoPersonalBtn.addEventListener("click", () => {
      const pedido = getPedidoActual();
      if (!pedido) {
        showToast("warn", "No hay pedido seleccionado, apa.");
        return;
      }
      const monto = parseFloat(gpMontoInput.value) || 0;
      const motivo = gpMotivoInput.value.trim();
      if (!monto) {
        showToast("warn", "Pon un monto v√°lido para el gasto personal.");
        return;
      }
      if (!motivo) {
        showToast("warn", "Describe el motivo del gasto personal, apa.");
        return;
      }
      pedido.gastosPersonales.push({
        id: uuid(),
        monto,
        motivo,
        fecha: new Date().toISOString()
      });
      gpMontoInput.value = "";
      gpMotivoInput.value = "";
      showToast("info", "Gasto personal registrado ‚úîÔ∏è", true);
      renderTodo();
    });

    agregarVentaBtn.addEventListener("click", () => {
      const pedido = getPedidoActual();
      if (!pedido) {
        showToast("warn", "No hay pedido seleccionado, apa.");
        return;
      }

      const nombre = ventaNombreInput.value.trim();
      const cantidadVendida = parseFloat(ventaCantidadInput.value) || 0;
      const precioTotal = parseFloat(ventaPrecioInput.value) || 0;

      if (!nombre) {
        showToast("warn", "Pon el nombre de la pieza vendida.");
        return;
      }
      if (!cantidadVendida) {
        showToast("warn", "Cantidad vendida inv√°lida.");
        return;
      }
      if (!precioTotal) {
        showToast("warn", "Pon un precio v√°lido.");
        return;
      }

      pedido.ventas.push({
        id: uuid(),
        nombre,
        cantidadVendida,
        precioTotal,
        fecha: new Date().toISOString()
      });

      ventaNombreInput.value = "";
      ventaCantidadInput.value = "";
      ventaPrecioInput.value = "";

      showToast("success", "Venta registrada ‚úîÔ∏è", true);
      renderTodo();
    });



    function onEditarCampoPieza(e) {

      const input = e.target;

      const itemId = input.dataset.itemId;

      const field = input.dataset.field;



      const pedido = getPedidoActual();

      if (!pedido) return;

      const item = pedido.items.find(it => it.id === itemId);

      if (!item) return;



      const value = parseFloat(input.value) || 0;

      if (["pvSugerido"].includes(field)) {

        item[field] = value;

      }



      recalcularGanancia(item);

      renderTodo();

    }



    // === INIT ===

    document.addEventListener("DOMContentLoaded", () => {

      cargarLocal();

      renderTodo();

      const savedTheme = localStorage.getItem(THEME_STORAGE_KEY) || "auto";
      applyTheme(savedTheme);

    });

  </script>

</body>

</html>


